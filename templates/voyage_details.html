{% extends 'base.html' %}

{% block content %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        .printable-area, .printable-area * {
            visibility: visible;
        }
        .printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print, .no-print * {
            display: none !important;
        }
    }
</style>
<div class="mb-4">
    <h1 class="mb-1"><i class="bi bi-airplane-fill"></i> Voyage : {{ voyage.destination }}</h1>
    <span class="badge bg-success fs-5">Prix par élève : {{ voyage.prix_eleve|format_currency }} €</span>
</div>
<!-- Modal Remboursements (unique, hors boucle) -->
<div class="modal fade" id="modalRemboursements" tabindex="-1" aria-labelledby="modalRemboursementsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRemboursementsLabel"><i class="bi bi-cash-coin"></i> Élèves à rembourser</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Classe</th>
                            <th>Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set remboursables = participants | selectattr('a_rembourser', '>', 0) | selectattr('remboursement_validé', 'equalto', 0) | list %}
                        {% for p in remboursables %}
                        <tr class="text-center">
                            <td>{{ p.nom }}</td>
                            <td>{{ p.prenom }}</td>
                            <td>{{ p.classe }}</td>
                            <td class="text-warning fw-bold">{{ p.a_rembourser/100|float|round(2) }} €</td>
                            <td>
                                <form action="{{ url_for('valider_remboursement', participant_id=p.id) }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-success">Valider</button>
                                </form>
                                <a href="{{ url_for('generer_attestation_remboursement_pdf', participant_id=p.id) }}" class="btn btn-sm btn-outline-secondary ms-1" target="_blank" title="Télécharger l'attestation PDF">
                                    <i class="bi bi-file-earmark-pdf"></i> Attestation
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center text-muted">Aucun élève à rembourser.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Section Récapitulatif -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Participants</h5>
                <p class="card-text fs-2 fw-bold">{{ nb_inscrits }} / {{ voyage.nb_participants_attendu }}</p>
                {% if nb_attente > 0 %}
                <p class="mb-0"><span class="badge bg-info">{{ nb_attente }} en liste d'attente</span></p>
                {% endif %}
                <small class="text-muted">Inscrits / Attendus</small>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-graph-up-arrow"></i> Finances</h5>
                <p class="mb-1">Total perçu : <strong class="text-success">{{ total_percu_voyage|format_currency }} €</strong></p>
                <p class="mb-2">Montant total attendu : <strong class="text-primary">{{ montant_total_attendu|format_currency }} €</strong></p>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ (total_percu_voyage / montant_total_attendu * 100) if montant_total_attendu > 0 else 0 }}%;" aria-valuenow="{{ total_percu_voyage }}" aria-valuemin="0" aria-valuemax="{{ montant_total_attendu }}">{{ "%.0f"|format((total_percu_voyage / montant_total_attendu * 100) if montant_total_attendu > 0 else 0) if montant_total_attendu > 0 else '0' }}%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Onglets de navigation -->
<ul class="nav nav-tabs nav-fill mb-4 no-print" id="voyageTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link {% if request.args.get('tab') == None %}active{% endif %}" href="{{ url_for('voyage_details', voyage_id=voyage.id) }}">
            <i class="bi bi-people-fill"></i> Participants
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.args.get('tab') == 'fonds_sociaux' %}active{% endif %}" href="{{ url_for('fonds_sociaux', voyage_id=voyage.id) }}">
            <i class="bi bi-piggy-bank-fill"></i> Fonds Sociaux
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.args.get('tab') == 'budget' %}active{% endif %}" href="{{ url_for('voyage_budget', voyage_id=voyage.id) }}">
            <i class="bi bi-calculator-fill"></i> Budget
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if request.args.get('tab') == 'documents' %}active{% endif %}" href="{{ url_for('voyage_details', voyage_id=voyage.id, tab='documents') }}">
            <i class="bi bi-folder-fill"></i> Documents
        </a>
    </li>
</ul>

<div class="tab-content">
    <!-- Onglet Participants -->
    <div class="tab-pane fade {% if request.args.get('tab') != 'documents' and request.args.get('tab') != 'budget' and request.args.get('tab') != 'fonds_sociaux' %}show active{% endif %}" id="participants">
        <!-- Section Élèves à rembourser -->
        {% set remboursables = participants | selectattr('a_rembourser', '>', 0) | selectattr('remboursement_validé', 'equalto', 0) | list %}
        {% if remboursables|length > 0 %}
        <div class="card shadow-sm mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Élèves à rembourser</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Classe</th>
                            <th>Montant à rembourser</th>
                            <th class="no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in remboursables %}
                        <tr class="text-center">
                            <td>{{ p.nom }}</td>
                            <td>{{ p.prenom }}</td>
                            <td>{{ p.classe }}</td>
                            <td class="text-warning fw-bold">{{ p.a_rembourser/100|float|round(2) }} €</td>
                            <td class="no-print">
                                <form action="{{ url_for('valider_remboursement', participant_id=p.id) }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-success">Valider</button>
                                </form>
                                <a href="{{ url_for('generer_attestation_remboursement_pdf', participant_id=p.id) }}" class="btn btn-sm btn-outline-secondary ms-1" target="_blank" title="Télécharger l'attestation PDF">
                                    <i class="bi bi-file-earmark-pdf"></i> Attestation
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        <!-- Section Ajouter un participant -->
        <div class="card shadow-sm mb-4 no-print">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-plus-fill"></i> Ajouter un participant (élève)</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('ajouter_participant') }}" method="post" class="row g-3 align-items-end">
                    <input type="hidden" name="voyage_id" value="{{ voyage.id }}">
                    <div class="col-md"><label for="nom" class="form-label">Nom</label><input type="text" class="form-control" name="nom" required></div>
                    <div class="col-md"><label for="prenom" class="form-label">Prénom</label><input type="text" class="form-control" name="prenom" required></div>
                    <div class="col-md"><label for="classe" class="form-label">Classe</label><input type="text" class="form-control" name="classe" required></div>
                    <div class="col-md-auto"><button type="submit" class="btn btn-primary w-100">Inscrire</button></div>
                </form>
            </div>
        </div>
        <div class="table-responsive printable-area">
            <div class="mb-3 no-print d-flex justify-content-end">
                <a href="{{ url_for('export_liste_pdf', voyage_id=voyage.id) }}" class="btn btn-outline-primary me-2"><i class="bi bi-file-earmark-pdf"></i> Exporter la liste (PDF)</a>
            </div>
            <table class="table align-middle table-bordered table-hover bg-white">
                <thead class="table-light">
                    <tr class="align-middle text-center">
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Classe</th>
                        <th>Statut</th>
                        <th>Total payé</th>
                        <th>Reste à payer</th>
                        <th>À rembourser</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for p in participants %}
                    <tr class="text-center{% if p.a_rembourser > 0 and p.statut == 'A_REMBOURSER' and p.remboursement_validé == 0 %} table-danger fw-bold text-danger{% endif %}">
                        <td>{{ p.nom }}</td>
                        <td>{{ p.prenom }}</td>
                        <td>{{ p.classe }}</td>
                        <td>{{ p.statut }}</td>
                        <td>{{ p.total_paye|format_currency }} €</td>
                        <td>{{ p.reste_a_payer|format_currency }} €</td>
                        <td>
                            {% if p.a_rembourser and p.a_rembourser > 0 %}
                                <span class="fw-bold text-danger">{{ p.a_rembourser/100|float|round(2) }} €</span>
                                {% if p.statut == 'A_REMBOURSER' and p.remboursement_validé == 0 %}
                                    <form action="{{ url_for('valider_remboursement', participant_id=p.id) }}" method="post" class="d-inline ms-2">
                                        <button type="submit" class="btn btn-sm btn-success">Valider remboursement</button>
                                    </form>
                                    <a href="{{ url_for('generer_attestation_pdf', participant_id=p.id) }}" class="btn btn-sm btn-outline-secondary ms-1" target="_blank" title="Télécharger l'attestation PDF">
                                        <i class="bi bi-file-earmark-pdf"></i> Attestation
                                    </a>
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="no-print">
                            <div class="d-flex justify-content-center gap-1">
                                <a href="{{ url_for('participant_paiements', participant_id=p.id) }}" class="btn btn-sm btn-outline-primary" title="Paiements"><i class="bi bi-cash-coin"></i></a>
                                <form action="{{ url_for('modifier_statut_participant') }}" method="post" class="d-inline">
                                    <input type="hidden" name="voyage_id" value="{{ voyage.id }}">
                                    <input type="hidden" name="participant_id" value="{{ p.id }}">
                                    <input type="hidden" name="statut" value="ANNULÉ">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Annuler" onclick="return confirm('Confirmer l’annulation/désinscription de cet élève ?')"><i class="bi bi-person-x"></i></button>
                                </form>
                                <form action="{{ url_for('modifier_statut_participant') }}" method="post" class="d-inline">
                                    <input type="hidden" name="voyage_id" value="{{ voyage.id }}">
                                    <input type="hidden" name="participant_id" value="{{ p.id }}">
                                    <input type="hidden" name="statut" value="INSCRIT">
                                    <button type="submit" class="btn btn-sm btn-outline-success" title="Repasser en inscrit">↩</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Onglet Documents -->
    <div class="tab-pane fade {% if request.args.get('tab') == 'documents' %}show active{% endif %}" id="documents">
        <div class="card shadow-sm mb-4 no-print">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-plus-fill"></i> Ajouter un document</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('ajouter_document', voyage_id=voyage.id) }}" method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
                    <div class="col-md-9">
                        <label for="document" class="form-label">Fichier</label>
                        <input type="file" class="form-control" name="document" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Ajouter le document</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-folder-fill"></i> Documents du voyage</h5>
            </div>
            {% if documents %}
            <table class="table table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Nom du fichier</th>
                        <th>Date d'ajout</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                    <tr>
                        <td>{{ doc.nom_fichier }}</td>
                        <td>{{ doc.date_upload }}</td>
                        <td class="no-print">
                            <a href="{{ url_for('telecharger_document', filename=doc.chemin_stockage) }}" class="btn btn-sm btn-info">
                                <i class="bi bi-download"></i> Télécharger
                            </a>
                            <form action="{{ url_for('supprimer_document', doc_id=doc.id) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Supprimer ce document ?');">
                                    <i class="bi bi-trash"></i> Supprimer
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="card-body text-muted text-center">
                Aucun document pour ce voyage.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
