{% extends 'base.html' %}

{% block content %}
<div id="pdfToolbar" class="d-flex justify-content-between align-items-center mb-2" style="position:fixed; top:0; left:0; right:0; padding:0.5rem 1rem; background:#fff; z-index:9999; box-shadow:0 2px 6px rgba(0,0,0,0.12);">
    <div>
        <h4 class="mb-0">{{ title }}</h4>
    </div>
    <div>
        <button id="btnRetour" class="btn btn-secondary me-2" onclick="window.location.href='{{ return_url }}'">← Retour</button>
        <button id="btnFermer" class="btn btn-outline-secondary me-2" onclick="window.close();">Fermer</button>
        <a href="{{ pdf }}" class="btn btn-primary" target="_blank" rel="noopener noreferrer"><i class="bi bi-download"></i> Télécharger</a>
    </div>
</div>

    <a id="pdfLink" href="{{ pdf }}" style="display:none"></a>
    <div id="pdfMeta" data-method="{{ method }}" data-post_data="{{ post_data or '' }}" style="display:none"></div>
    <div style="height: calc(100vh - 64px); margin-top:64px;">
    <iframe id="pdfFrame" name="pdfFrame" src="" style="width:100%;height:100%;border:none;"></iframe>
</div>

<script>
(function(){
    const pdf = document.getElementById('pdfLink').getAttribute('href');
    const meta = document.getElementById('pdfMeta');
    const method = meta ? meta.dataset.method : 'GET';
    const post_data_b64 = meta ? meta.dataset.post_data : '';

    if(!pdf){
        document.getElementById('pdfFrame').src = 'about:blank';
        return;
    }

    if(method === 'GET' || !post_data_b64){
        // Ensure the viewer receives focus immediately so the first click is not swallowed by the overlay/iframe
        try { window.focus(); } catch(e){};
        try { document.getElementById('btnRetour').focus(); } catch(e){};
        document.getElementById('pdfFrame').src = pdf;
        return;
    }

    // If POST, post the decoded JSON data as a form targetting the iframe
    try{
        const jsonStr = decodeURIComponent(escape(window.atob(post_data_b64)));
        const payload = JSON.parse(jsonStr);
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = pdf;
        form.target = 'pdfFrame';
        form.style.display = 'none';

        function appendInput(name, value){
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }

        Object.keys(payload).forEach(k => {
            const v = payload[k];
            if(Array.isArray(v)){
                v.forEach(item => appendInput(k + '[]', item));
            } else {
                appendInput(k, v);
            }
        });

        document.body.appendChild(form);
        form.submit();
    } catch(e){
        console.error('Viewer: failed to post payload to pdf endpoint', e);
        document.getElementById('pdfFrame').src = pdf; // fallback
    }
    // attempt to focus the controls periodically for a short time to avoid requiring a second click (works around some webview focus bugs)
    var focusAttempts = 0;
    var focusInterval = setInterval(function(){
        try { window.focus(); } catch(e){}
        try { document.getElementById('btnRetour').focus(); } catch(e){}
        focusAttempts += 1;
        if(focusAttempts > 10){ clearInterval(focusInterval);} 
    }, 200);
})();
</script>

{% endblock %}
